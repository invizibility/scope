<html>

<head>
    <title>Genome Scope</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/style0/lib.css">
    <script type="text/javascript" src="/lib/d3.v4.min.js"></script>
    <script type="text/javascript" src="/lib/d3-queue.v2.min.js"></script>
    <script type="text/javascript" src="/lib/d3-request.v1.min.js"></script>
    <script type="text/javascript" src="/lib/jquery.min.js"></script>
    <script type="text/javascript" src="/lib/bootstrap.min.js"></script>
</head>

<body>

    <!--
    <div id="top" class="menu">
        <label for="width"> width </label> <span id="width"></span>
        <label for="height"> height </label> <span id="height"></span>
    </div>
    <div id="left" class="container">
    </div>
    <div id="main" class="container">
    </div>
  -->
</body>
<script type="text/javascript" src="/lib0/lib.js"></script>
<script>
    (function(d3, $, S) {
        var H = S.dataHic;
        var B = S.dataBigwig;
        var body = d3.select("body")
        var scope = {}
        var top = body.append("div").attr("id", "top")
            .classed("container", true)
        var main = body.append("div").attr("id", "main")
            .classed("container", true)
        var left = body.append("div").attr("id", "left")
            .classed("container", true)
        top.append("label").attr("for", "width").text("width")
        var width = top.append("span").attr("id", "width")
        top.append("label").attr("for", "height").text("height")
        var height = top.append("span").attr("id", "height")
        var panel = main.append("div").style("position", "relative")
        var canvas = panel.append("canvas").style("postion", "absolute")
            //var svgdiv = main.append("div").style("position", "absolute") //TO GET X Y for region 1 and region 2.
            //var svg = svgdiv.append("svg") //design for brushes.
        var background = "#BBB"

        $(window).resize(function() {
            resize()
        })
        var resize = function() {
            //var canvasdiv = d3.select("#canvasdiv")
            scope.width = $(window).width() - 200
            scope.height = $(window).height() - 30
            canvas.attr("width", scope.width).attr("height", scope.height)
                //svg.attr("width", scope.width).attr("height", scope.height)
            main.style("height", scope.height + "px")
            main.style("width", scope.width + "px")
            width.text(scope.width)
            height.text(scope.height)
                //var b = svg.append("g").attr("class", "brush")
                //b.call(brush)

        }
        resize()
        var URI = "/hic"
        var hicCtrl, regionCtrl, paraMonitor;
        var hicOpts = {}
        var hicCtrlDiv = left.append("div")
        var regionCtrlDiv = left.append("div")

        var addChrPrefix = function(r) { //TODO fix using idx , XY bug
                var s = []
                r.forEach(function(d) {
                    s.push({
                        "start": d.start,
                        "end": d.end,
                        "chr": "chr" + d.chr
                    })
                })
                console.log(s)
                return s
            }
            /* get parameters of regions and hic , then render */

        var plot = function(d) {
            var ctx = canvas.node().getContext("2d");
            ctx.fillStyle = background
            ctx.fillRect(0, 0, scope.width, scope.height)
            console.log(hicCtrl.state())
            console.log(regionCtrl.regions())
            var hic = hicCtrl.state()
            var regions = d || regionCtrl.regions() //TODO

            var edge = Math.min(scope.height - 100, scope.width - 40)
            var bw = B.canvas()
                .URI("")
                .x(20)
                .y(scope.height - 60)
                .width(edge)
                .regions(addChrPrefix(regions))
                .panel(panel)
            var setRegions = function(e) {
                var regions = regionCtrl.regions();
                regions.forEach(function(d, i) {
                    d.start = e[i].start
                    d.end = e[i].end
                })
                regionCtrl.regions(regions)
                bw.response(regions)
                console.log(regions)
            }
            var showPara = function(d) {
                var paratable = S.paraTable().data(d)
                paraMonitor.call(paratable)
            }
            var chart = H.canvas()
                .URI(URI)
                .norm(hic.norm)
                .unit(hic.unit)
                .bpres(hicOpts.bpres)
                .xoffset(20)
                .yoffset(20)
                .width(edge)
                .height(edge)
                .regions(regions)
                .panel(panel)
                .color1(hic.color1)
                .color2(hic.color2)
                //.svg(svgdiv)
                //.panel(panel)
                .emit(setRegions)
                .callback(showPara)
            var colorbar = S.colorBar().color1(hic.color1).color2(hic.color2).x(scope.width - 100).y(scope.height - 50)

            canvas.call(chart).call(colorbar)
            canvas.call(bw)

        }
        var btns = left.append("div").classed("btn-group", true)
        var btns2 = left.append("div").classed("btn-group", true)
        btns.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-backward"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                var l = Math.round((regions[0].end - regions[0].start) / 2)
                var d = regions[0]
                regions[0].start = d.start - l < 0 ? 0 : d.start - l
                regions[0].end = d.end - l < 0 ? d.end : d.end - l
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        btns2.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-zoom-in"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                regions.forEach(function(d, i) {
                    var l = Math.round((d.end - d.start) / 3)
                    regions[i].start = d.start + l
                    regions[i].end = d.end - l
                })
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        btns.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-play"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                plot();
            })
        btns2.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-zoom-out"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                regions.forEach(function(d, i) {
                    var l = d.end - d.start
                    regions[i].start = d.start - l < 0 ? 0 : d.start - l
                    regions[i].end = d.end + l > d.length ? d.length : d.end + l
                })
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        btns.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-forward"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                var d = regions[0]
                var l = Math.round((regions[0].end - regions[0].start) / 2)
                regions[0].start = d.start + l > d.length ? d.start : d.start + l
                regions[0].end = d.end + l > d.length ? d.length : d.end + l
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        var btns3 = left.append("div").classed("btn-group", true)
        btns3.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-triangle-top"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                var l = Math.round((regions[1].end - regions[1].start) / 2)
                var d = regions[1]
                regions[1].start = d.start - l < 0 ? 0 : d.start - l
                regions[1].end = d.end - l < 0 ? d.end : d.end - l
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        btns3.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-triangle-bottom"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                var d = regions[1]
                var l = Math.round((regions[1].end - regions[1].start) / 2)
                regions[1].start = d.start + l > d.length ? d.start : d.start + l
                regions[1].end = d.end + l > d.length ? d.length : d.end + l
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        var paraMonitor = left.append("div").classed("panel", true)
        var renderHicCtrlPanel = function(data) {
            hicOpts = data;
            hicCtrl = H.chart().data(data);
            hicCtrlDiv.call(hicCtrl)
            regionCtrl = S.regionForm().chrs(data.chrs).regionNum(2).send(plot)
            regionCtrlDiv.call(regionCtrl)
        }
        H.Get(URI, renderHicCtrlPanel)
        B.Get("", console.log)
    }(d3, jQuery, snow));
</script>

</html>
