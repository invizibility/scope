<html>

<head>
    <title>Genome Scope</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/style0/lib.css">
    <script type="text/javascript" src="/lib/d3.v4.min.js"></script>
    <script type="text/javascript" src="/lib/d3-queue.v2.min.js"></script>
    <script type="text/javascript" src="/lib/d3-request.v1.min.js"></script>
    <script type="text/javascript" src="/lib/jquery.min.js"></script>
    <script type="text/javascript" src="/lib/bootstrap.min.js"></script>
</head>

<body>

    <!--
    <div id="top" class="menu">
        <label for="width"> width </label> <span id="width"></span>
        <label for="height"> height </label> <span id="height"></span>
    </div>
    <div id="left" class="container">
    </div>
    <div id="main" class="container">
    </div>
  -->
</body>
<!--
<script type="text/javascript" src="/lib0/axis.js"></script>
<script type="text/javascript" src="/lib0/axes.js"></script>
<script type="text/javascript" src="/lib0/brush.js"></script>
<script type="text/javascript" src="/lib0/brushtri.js"></script>
<script type="text/javascript" src="/lib0/scopebrush.js"></script>
-->
<script type="text/javascript" src="/lib0/snow.js"></script>
<!--
<script type="text/javascript" src="/lib0/bigwig.js"></script>
-->
<script>
    (function(d3, $, S) {
        var trimChr = function(regions) {
            var a = []
            regions.forEach(function(d) {
                a.push({
                    "chr": d.chr.replace("chr", ""),
                    "start": d.start,
                    "end": d.end
                })
            })
            return a
        }

        var H = S.dataHic2;
        var B = S.dataBigwig;
        var dispatch = d3.dispatch("changeDomain")
        var body = d3.select("body")
        var scope = {} //TODO

        var top = body.append("div").attr("id", "top")
            .classed("container", true)
        var nav = top.append("nav").classed("navbar", true).classed("navbar-default", true)
        var navl = nav.append("div").classed("navbar-inner-sm", true).append("ul").classed("nav", true).classed("navbar-nav", true)
        navl.append("li").classed("active", true).append("a").attr("href", "#").text("Modern")
        navl.append("li").append("a").attr("href", "/index2.html").text("Classic")
        var main = body.append("div").attr("id", "main")
            .classed("container", true)
        var left = body.append("div").attr("id", "left")
            .classed("container", true)
        var btns = left.append("div").classed("btn-group", true)
        var btns2 = left.append("div").classed("btn-group", true)
        var btns3 = left.append("div").classed("btn-group", true)
        var paraPanel = left.append("div").classed("panel", true)
        var navr = nav.append("div").style("text-align", "right")
        navr.append("label").attr("for", "width").text("width")
        var width = navr.append("span").attr("id", "width")
        navr.append("label").attr("for", "height").text("height")
        var height = navr.append("span").attr("id", "height")
        var panel = main.append("div").style("position", "relative")
        var canvas = panel.append("canvas").style("postion", "absolute")
        var svg = panel.append("svg").style("position", "absolute")
        var axesG = svg.append("g").attr("transform", "translate(80,0)")

        //var svgdiv = main.append("div").style("position", "absolute") //TO GET X Y for region 1 and region 2.
        //var svg = svgdiv.append("svg") //design for brushes.
        var background = "#BBB"

        $(window).resize(function() {
            resize()
        })

        var resize = function() {
            //var canvasdiv = d3.select("#canvasdiv")
            console.log("in Resize")
            scope.width = $(window).width() - 200
            scope.height = $(window).height() - 30
            console.log(scope)
            canvas.attr("width", scope.width).attr("height", scope.height)
            svg.attr("width", scope.width).attr("height", scope.height)

            main.style("height", scope.height + "px")
            main.style("width", scope.width + "px")
            width.text(scope.width)
            height.text(scope.height)
            //var b = svg.append("g").attr("class", "brush")
            //b.call(brush)

        }
        resize()
        var URI = "/hic"
        var hicCtrl, regionCtrl, bigwigCtrl, paraMonitor;
        var hicOpts = {}
        var hicCtrlPanel = left.append("div").classed("panel", true)
        //hicCtrlPanel.append("div").classed("panel-heading", true).append("h3").classed("panel-title", true).text("HiC Ctrl")
        var hicCtrlDiv = hicCtrlPanel.append("div").classed("panel-body", true)
        var regionCtrlPanel = left.append("div").classed("panel", true)
        //regionCtrlPanel.append("div").classed("panel-heading", true).text("Regions Ctrl")
        var regionCtrlDiv = regionCtrlPanel.append("div").classed("panel-body", true)
        var bigwigCtrlPanel = left.append("div").classed("panel", true)
        //bigwigCtrlPanel.append("div").classed("panel-heading", true).text("Track Ctrl")
        var bigwigCtrlDiv = bigwigCtrlPanel.append("div").classed("panel-body", true)


        var addChrPrefix = function(r) { //TODO fix using idx , XY bug
            var s = []
            r.forEach(function(d) {
                s.push({
                    "start": d.start,
                    "end": d.end,
                    "chr": "chr" + d.chr
                })
            })
            console.log(s)
            return s
        }
        /* get parameters of regions and hic , then render */

        var plot = function(d) {
            var ctx = canvas.node().getContext("2d");
            ctx.fillStyle = background
            console.log(scope)
            ctx.fillRect(0, 0, scope.width, scope.height)
            //  console.log(hicCtrl.state())
            //  console.log(regionCtrl.regions())
            var hic = hicCtrl.state()
            var bigwig = bigwigCtrl.state()
            var regions = d || regionCtrl.regions() //TODO

            var edge = Math.min(scope.height - 100, scope.width - 40)
            var scopebrush = S.scopebrush().width(edge).on("brush", function(d) {
                //bw.response(d)
                //bw4.response(d)
                setRegions(d)
            }).on("click", function(d) {
                plot(d)
            }).regions(regions)
            axesG.selectAll("*").remove()
            axesG.call(scopebrush)
            var bw = B.canvas()
                .URI("/bw")
                .id(bigwig[1].track)
                .x(80)
                .y(edge / 2 + 40)
                .width(edge)
                .gap(20) //TODO REMV
                .regions(addChrPrefix(regions))
                .panel(panel)
                .mode(1)
                .pos(1)
            var bw4 = B.canvas()
                .URI("/bw")
                .id(bigwig[0].track)
                .x(80)
                .y(edge / 2 + 120)
                .width(edge)
                .gap(20)
                .regions(addChrPrefix(regions))
                .panel(panel)
                .mode(1)
                //.vertical(true)
                .pos(4)
            var setRegions = function(e) {
                var regions = e;
                //var regions = regionCtrl.regions();
                regions.forEach(function(d, i) {
                    d.chr = e[i].chr
                    d.start = e[i].start
                    d.end = e[i].end
                })
                regionCtrl.regions(regions)
                bw.response(regions)
                bw4.response(regions)
                console.log(regions)
            }
            var showPara = function(d) {
                var paratable = S.paraTable().data(d)
                console.log("paras", d)
                threshold.attr("max", d.max).attr("min", d.min).attr("value", d.max)
                cutoff = d.max
                paraMonitor.call(paratable)
            }




            var chart = H.canvas()
                .URI(URI)
                .norm(hic.norm)
                .unit(hic.unit)
                .bpres(hicOpts.bpres)
                .xoffset(80)
                .yoffset(edge * 0.5)
                .width(edge)
                .height(edge)
                .regions(regions)
                .panel(panel)
                .color1(hic.color1)
                .color2(hic.color2)
                //.svg(svgdiv)
                //.panel(panel)
                .emit(setRegions)
                .callback(showPara)

            var colorbar = S.colorbar().color1(hic.color1).color2(hic.color2).x(scope.width - 100).y(scope.height - 50)

            canvas.call(chart).call(colorbar)
            canvas.call(bw)
            canvas.call(bw4)

            //TODO IMPROVE .
            dispatch.on("changeDomain", function(d) {
                chart.domain(d)
                chart.render()
            })

            /*
            axesG.selectAll("*").remove()
            axesG.call(S.axes().regions(regions).width(edge).on("submit", function(d) {
                console.log("submit", d)
                plot(d)
            }).on("brush", function(d) {
                console.log("resp", d)
                setRegions(d)
            }))
            */
        }

        btns.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-backward"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                var l = Math.round((regions[0].end - regions[0].start) / 2)
                var d = regions[0]
                regions[0].start = d.start - l < 0 ? 0 : d.start - l
                regions[0].end = d.end - l < 0 ? d.end : d.end - l
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        btns2.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-zoom-in"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                regions.forEach(function(d, i) {
                    var l = Math.round((d.end - d.start) / 3)
                    regions[i].start = d.start + l
                    regions[i].end = d.end - l
                })
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        btns.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-play"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                plot();
            })
        btns2.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-zoom-out"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                regions.forEach(function(d, i) {
                    var l = d.end - d.start
                    regions[i].start = d.start - l < 0 ? 0 : d.start - l
                    regions[i].end = d.end + l > d.length ? d.length : d.end + l
                })
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        btns.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-forward"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                var d = regions[0]
                var l = Math.round((regions[0].end - regions[0].start) / 2)
                regions[0].start = d.start + l > d.length ? d.start : d.start + l
                regions[0].end = d.end + l > d.length ? d.length : d.end + l
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        btns3.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-triangle-top"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                var l = Math.round((regions[1].end - regions[1].start) / 2)
                var d = regions[1]
                regions[1].start = d.start - l < 0 ? 0 : d.start - l
                regions[1].end = d.end - l < 0 ? d.end : d.end - l
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })
        btns3.append("button")
            .classed("btn", true)
            .html('<small><span class="glyphicon glyphicon-triangle-bottom"></span></small>')
            .on("click", function() {
                var regions = regionCtrl.regions();
                var d = regions[1]
                var l = Math.round((regions[1].end - regions[1].start) / 2)
                regions[1].start = d.start + l > d.length ? d.start : d.start + l
                regions[1].end = d.end + l > d.length ? d.length : d.end + l
                regionCtrl.regions(regions)
                regionCtrlDiv.call(regionCtrl)
                plot();
            })


        var paraCtrl = paraPanel.append("div")
        var paraMonitor = paraPanel.append("div")
        var threshold = paraCtrl.append("input").attr("type", "range")
        var cutoff
        threshold.on("change", function(d) {
            cutoff = this.value
        })
        ///TODO GET para.
        paraCtrl.append("button")
            .classed("btn", true)
            .html('<small>re-render hic</small>')
            .on("click", function() {
                dispatch.call("changeDomain", this, [0, cutoff])
            })
        var renderHicCtrlPanel = function(data) {
            hicOpts = data;
            hicCtrl = H.chart().data(data);
            hicCtrlDiv.call(hicCtrl)
            regionCtrl = S.regionForm().chrs(data.chrs).regionNum(2).send(plot)
            regionCtrlDiv.call(regionCtrl)
        }
        var renderBwCtrlPanel = function(data) {
            bigwigCtrl = S.dataBigwig.form().data(data).number(2)
            bigwigCtrlDiv.call(bigwigCtrl)
        }
        H.Get(URI, renderHicCtrlPanel)
        B.Get("/bw", renderBwCtrlPanel)
    }(d3, jQuery, snow));
</script>

</html>
